import{a0 as c,a1 as h,a3 as A,Z as m}from"./index.d93609e1.js";import{l as S,g as z,u as E,i as k,a as O,C as P,b as L,c as y,e as M,m as R,p as B,P as F,f as Q,h as W,j as G,k as T}from"./a.1d79356f.js";import{i as U}from"./is-plan-event-enabled.6c12943d.js";import"./layout.f9def072.js";import"./use-notification.72cae862.js";import"./index.29264f5e.js";import"./error-messages.4f441108.js";import"./index.esm.fbd7e18b.js";import"./index.0fbc69fc.js";import"./index.397ea021.js";function I(e){return e.toLowerCase().replace(".","").replace(/\s+/g,"-")}function N(e,t){return t===void 0&&(t=!1),t?btoa(e).replace(/=/g,""):void 0}function V(e,t,n){var i,r;try{var a=((r=(i=window==null?void 0:window.performance)===null||i===void 0?void 0:i.getEntriesByName(e,"resource"))!==null&&r!==void 0?r:[])[0];a&&t.stats.gauge("legacy_destination_time",Math.round(a.duration),A([n],a.duration<100?["cached"]:[],!0))}catch{}}function Z(e,t,n,i,r,a){return c(this,void 0,void 0,function(){var o,s,u,f,l,v,d,w,g;return h(this,function(p){switch(p.label){case 0:o=I(n),s=N(o,a),u=z(),f="".concat(u,"/integrations/").concat(s!=null?s:o,"/").concat(i,"/").concat(s!=null?s:o,".dynamic.js.gz"),p.label=1;case 1:return p.trys.push([1,3,,4]),[4,S(f)];case 2:return p.sent(),V(f,e,n),[3,4];case 3:throw l=p.sent(),e.stats.gauge("legacy_destination_time",-1,["plugin:".concat(n),"failed"]),l;case 4:return v=window["".concat(o,"Deps")],[4,Promise.all(v.map(function(_){return S(u+_+".gz")}))];case 5:return p.sent(),window["".concat(o,"Loader")](),d=window["".concat(o,"Integration")],d.Integration&&(w={user:function(){return t.user()},addIntegration:function(){}},d(w),d=d.Integration),g=new d(r),g.analytics=t,[2,g]}})})}function H(e,t,n){return c(this,void 0,void 0,function(){var i,r,a,o;return h(this,function(s){return i=z(),r=I(e),a=N(e,n),o="".concat(i,"/integrations/").concat(a!=null?a:r,"/").concat(t,"/").concat(a!=null?a:r,".dynamic.js.gz"),[2,E(o)]})})}function J(e){var t,n,i,r;return(r=(n=(t=e.versionSettings)===null||t===void 0?void 0:t.override)!==null&&n!==void 0?n:(i=e.versionSettings)===null||i===void 0?void 0:i.version)!==null&&r!==void 0?r:"latest"}function K(e,t){return c(this,void 0,void 0,function(){var n,i=this;return h(this,function(r){switch(r.label){case 0:return n=[],k()?[2,t]:[4,B(function(){return t.length>0&&G()},function(){return c(i,void 0,void 0,function(){var a,o,s;return h(this,function(u){switch(u.label){case 0:return a=t.pop(),a?[4,W(a,e)]:[2];case 1:return o=u.sent(),s=o instanceof T,s||n.push(a),[2]}})})})];case 1:return r.sent(),n.map(function(a){return t.pushWithBackoff(a)}),[2,t]}})})}var X=function(){function e(t,n,i,r){i===void 0&&(i={}),this.options={},this.type="destination",this.middleware=[],this._ready=!1,this._initialized=!1,this.flushing=!1,this.name=t,this.version=n,this.settings=m({},i),this.disableAutoISOConversion=r.disableAutoISOConversion||!1,this.settings.type&&this.settings.type==="browser"&&delete this.settings.type,this.options=r,this.buffer=r.disableClientPersistence?new F(4,[]):new Q(4,"dest-".concat(t)),this.scheduleFlush()}return e.prototype.isLoaded=function(){return this._ready},e.prototype.ready=function(){var t;return(t=this.onReady)!==null&&t!==void 0?t:Promise.resolve()},e.prototype.load=function(t,n){return c(this,void 0,void 0,function(){var i,r=this;return h(this,function(a){switch(a.label){case 0:return this._ready||this.onReady!==void 0?[2]:(i=this,[4,Z(t,n,this.name,this.version,this.settings,this.options.obfuscate)]);case 1:i.integration=a.sent(),this.onReady=new Promise(function(o){var s=function(){r._ready=!0,o(!0)};r.integration.once("ready",s)}),this.onInitialize=new Promise(function(o){var s=function(){r._initialized=!0,o(!0)};r.integration.on("initialize",s)});try{t.stats.increment("analytics_js.integration.invoke",1,["method:initialize","integration_name:".concat(this.name)]),this.integration.initialize()}catch(o){throw t.stats.increment("analytics_js.integration.invoke.error",1,["method:initialize","integration_name:".concat(this.name)]),o}return[2]}})})},e.prototype.unload=function(t,n){return H(this.name,this.version,this.options.obfuscate)},e.prototype.addMiddleware=function(){for(var t,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];this.middleware=(t=this.middleware).concat.apply(t,n)},e.prototype.shouldBuffer=function(t){return t.event.type!=="page"&&(k()||this._ready===!1||this._initialized===!1)},e.prototype.send=function(t,n,i){var r,a;return c(this,void 0,void 0,function(){var o,s,u,f,l,v;return h(this,function(d){switch(d.label){case 0:if(this.shouldBuffer(t))return this.buffer.push(t),this.scheduleFlush(),[2,t];if(o=(a=(r=this.options)===null||r===void 0?void 0:r.plan)===null||a===void 0?void 0:a.track,s=t.event.event,o&&s&&this.name!=="Segment.io"){if(u=o[s],U(o,u))t.updateEvent("integrations",m(m({},t.event.integrations),u==null?void 0:u.integrations));else return t.updateEvent("integrations",m(m({},t.event.integrations),{All:!1,"Segment.io":!0})),t.cancel(new P({retry:!1,reason:"Event ".concat(s," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"})),[2,t];if((u==null?void 0:u.enabled)&&(u==null?void 0:u.integrations[this.name])===!1)return t.cancel(new P({retry:!1,reason:"Event ".concat(s," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"})),[2,t]}return[4,L(this.name,t.event,this.middleware)];case 1:if(f=d.sent(),f===null)return[2,t];l=new n(f,{traverse:!this.disableAutoISOConversion}),t.stats.increment("analytics_js.integration.invoke",1,["method:".concat(i),"integration_name:".concat(this.name)]),d.label=2;case 2:return d.trys.push([2,5,,6]),this.integration?[4,O(this.integration.invoke.call(this.integration,i,l))]:[3,4];case 3:d.sent(),d.label=4;case 4:return[3,6];case 5:throw v=d.sent(),t.stats.increment("analytics_js.integration.invoke.error",1,["method:".concat(i),"integration_name:".concat(this.name)]),v;case 6:return[2,t]}})})},e.prototype.track=function(t){return c(this,void 0,void 0,function(){return h(this,function(n){return[2,this.send(t,y.Track,"track")]})})},e.prototype.page=function(t){var n;return c(this,void 0,void 0,function(){var i=this;return h(this,function(r){return((n=this.integration)===null||n===void 0?void 0:n._assumesPageview)&&!this._initialized&&this.integration.initialize(),[2,this.onInitialize.then(function(){return i.send(t,y.Page,"page")})]})})},e.prototype.identify=function(t){return c(this,void 0,void 0,function(){return h(this,function(n){return[2,this.send(t,y.Identify,"identify")]})})},e.prototype.alias=function(t){return c(this,void 0,void 0,function(){return h(this,function(n){return[2,this.send(t,y.Alias,"alias")]})})},e.prototype.group=function(t){return c(this,void 0,void 0,function(){return h(this,function(n){return[2,this.send(t,y.Group,"group")]})})},e.prototype.scheduleFlush=function(){var t=this;this.flushing||setTimeout(function(){return c(t,void 0,void 0,function(){var n;return h(this,function(i){switch(i.label){case 0:return this.flushing=!0,n=this,[4,K(this,this.buffer)];case 1:return n.buffer=i.sent(),this.flushing=!1,this.buffer.todo>0&&this.scheduleFlush(),[2]}})})},Math.random()*5e3)},e}();function ot(e,t,n,i){var r,a;if(t===void 0&&(t={}),n===void 0&&(n={}),M())return[];e.plan&&(n=n!=null?n:{},n.plan=e.plan);var o=(a=(r=e.middlewareSettings)===null||r===void 0?void 0:r.routingRules)!==null&&a!==void 0?a:[],s=R(e,n!=null?n:{});return Object.entries(e.integrations).map(function(u){var f,l=u[0],v=u[1];if(!l.startsWith("Segment")){var d=t.All===!1&&t[l]===void 0;if(!(t[l]===!1||d)){var w=v.type,g=v.bundlingStatus,p=v.versionSettings,_=g!=="unbundled"&&(w==="browser"||((f=p==null?void 0:p.componentTypes)===null||f===void 0?void 0:f.includes("browser")));if(!(!_&&l!=="Segment.io"||l==="Iterable")){var j=J(v),b=new X(l,j,s[l],n),C=o.filter(function(D){return D.destinationName===l});return C.length>0&&i&&b.addMiddleware(i),b}}}}).filter(function(u){return u!==void 0})}export{X as LegacyDestination,ot as ajsDestinations};
